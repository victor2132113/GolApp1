<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GolApp - Reportes y Estad√≠sticas</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2rem;
            font-weight: 700;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .filters {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .filter-select, .filter-input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-refresh {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-left: auto;
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 153, 225, 0.3);
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #718096;
            font-size: 1rem;
            font-weight: 500;
        }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: 600;
        }

        .stat-increase {
            color: #4299e1;
        }

        .stat-decrease {
            color: #e53e3e;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .tables-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .table-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #4a5568;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: flex-end;
        }

        .btn-export {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-export:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(66, 153, 225, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 250px;
            }

            .export-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Reportes y Estad√≠sticas</h1>
            <div class="nav-buttons">
                <a href="../index.html" class="nav-btn">Dashboard</a>
                <a href="../reservas.html" class="nav-btn">Reservas</a>
                <a href="../canchas.html" class="nav-btn">Canchas</a>
                <a href="usuarios.html" class="nav-btn">Usuarios</a>
            </div>
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <span class="user-name" id="userName">Usuario</span>
                    <span class="role-badge" id="userRole">Rol</span>
                    <span class="user-email" id="userEmail">üìß usuario@golapp.com</span>
                </div>
                <div class="user-actions">
                    <button class="logout-btn" onclick="logout()" title="Cerrar sesi√≥n">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Per√≠odo</label>
                <select id="periodFilter" class="filter-select">
                    <option value="7">Semana (7 d√≠as)</option>
                    <option value="30">Mes (30 d√≠as)</option>
                    <option value="year" selected>A√±o Actual</option>
                    <option value="365">A√±o Completo (365 d√≠as)</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Desde</label>
                <input type="date" id="dateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label class="filter-label">Hasta</label>
                <input type="date" id="dateTo" class="filter-input">
            </div>
            <button class="btn-refresh" onclick="loadReports()"> Actualizar</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Cargando reportes...</p>
        </div>

        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon"></div>
                <div class="stat-number" id="totalReservations">0</div>
                <div class="stat-label">Total Reservas</div>
                <div class="stat-change stat-increase" id="reservationsChange">+0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"></div>
                <div class="stat-number" id="totalRevenue">$0</div>
                <div class="stat-label">Ingresos Totales</div>
                <div class="stat-change stat-increase" id="revenueChange">+0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"></div>
                <div class="stat-number" id="activeFields">0</div>
                <div class="stat-label">Canchas Activas</div>
                <div class="stat-change" id="fieldsChange">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"></div>
                <div class="stat-number" id="activeUsers">0</div>
                <div class="stat-label">Usuarios Activos</div>
                <div class="stat-change stat-increase" id="usersChange">+0%</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Reservas por D√≠a</h3>
                <div class="chart-container">
                    <canvas id="reservationsChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Ingresos por Mes</h3>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Canchas M√°s Populares</h3>
                <div class="chart-container">
                    <canvas id="fieldsChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Horarios de Mayor Demanda</h3>
                <div class="chart-container">
                    <canvas id="hoursChart"></canvas>
                </div>
            </div>
        </div>

        <div class="tables-section">
            <div class="table-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="table-title">Top 10 Usuarios M√°s Activos</h3>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToCSV('topUsers')"> CSV</button>
                    </div>
                </div>
                <table class="data-table" id="topUsersTable">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Email</th>
                            <th>Reservas</th>
                            <th>Total Gastado</th>
                            <th>√öltima Reserva</th>
                        </tr>
                    </thead>
                    <tbody id="topUsersBody">
                    </tbody>
                </table>
            </div>

            <div class="table-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="table-title">Reservas Recientes</h3>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToCSV('recentReservations')"> CSV</button>
                    </div>
                </div>
                <table class="data-table" id="recentReservationsTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Usuario</th>
                            <th>Cancha</th>
                            <th>Horario</th>
                            <th>Estado</th>
                            <th>Precio</th>
                        </tr>
                    </thead>
                    <tbody id="recentReservationsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let charts = {};

        // Verificar autenticaci√≥n
        function checkAuth() {
            const user = localStorage.getItem('golapp_user');
            if (!user) {
                window.location.href = '../login.html';
                return false;
            }
            
            // Mostrar datos del usuario
            try {
                const currentUser = JSON.parse(user);
                document.getElementById('userName').textContent = currentUser.nombre || 'Usuario';
                
                // Formatear el rol con emoji
                const userRole = currentUser.rol || 'usuario';
                const roleElement = document.getElementById('userRole');
                if (roleElement) {
                    if (userRole.toLowerCase() === 'administrador' || userRole.toLowerCase() === 'admin') {
                        roleElement.textContent = 'üëë Administrador';
                        roleElement.className = 'role-badge admin';
                    } else {
                        roleElement.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                        roleElement.className = 'role-badge';
                    }
                }
                
                document.getElementById('userEmail').textContent = 'üìß ' + (currentUser.correo || currentUser.email || 'usuario@golapp.com');
            } catch (error) {
                console.error('Error parsing user data:', error);
            }
            
            return true;
        }

        // Logout
        function logout() {
            localStorage.removeItem('golapp_user');
            localStorage.removeItem('golapp_token');
            window.location.href = '../login.html';
        }

        // Cargar reportes
        async function loadReports() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                await Promise.all([
                    loadStats(),
                    loadCharts(),
                    loadTables()
                ]);
            } catch (error) {
                console.error('Error cargando reportes:', error);
                alert('Error al cargar los reportes');
            } finally {
                loading.style.display = 'none';
            }
        }

        // Funci√≥n para obtener el rango de fechas seg√∫n el filtro seleccionado
        function getDateRange() {
            const periodFilter = document.getElementById('periodFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            const today = new Date();
            let startDate, endDate;
            
            if (dateFrom && dateTo) {
                // Si hay fechas personalizadas, usarlas
                startDate = new Date(dateFrom);
                endDate = new Date(dateTo);
                endDate.setHours(23, 59, 59, 999); // Incluir todo el d√≠a final
            } else if (periodFilter === 'year') {
                // Para ingresos totales del a√±o actual
                startDate = new Date(today.getFullYear(), 0, 1); // 1 de enero del a√±o actual
                endDate = new Date(today.getFullYear(), 11, 31, 23, 59, 59, 999); // 31 de diciembre del a√±o actual
            } else {
                // Usar el filtro de per√≠odo predefinido (para compatibilidad con otros filtros)
                const days = parseInt(periodFilter);
                endDate = new Date(today);
                startDate = new Date(today.getTime() - (days * 24 * 60 * 60 * 1000));
            }
            
            console.log('üìÖ Rango de fechas:', { startDate, endDate, period: periodFilter });
            return { startDate, endDate };
        }

        // Funci√≥n para filtrar datos por fecha
        function filterDataByDate(data, dateField = 'fecha') {
            const { startDate, endDate } = getDateRange();
            
            return data.filter(item => {
                const itemDate = new Date(item[dateField] || item.fecha_reserva || item.fecha);
                return itemDate >= startDate && itemDate <= endDate;
            });
        }

        // Cargar estad√≠sticas generales
        async function loadStats() {
            try {
                console.log('üîÑ Cargando estad√≠sticas...');
                const [reservasRes, usuariosRes, canchasRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/reservas`),
                    fetch(`${API_BASE_URL}/usuarios`),
                    fetch(`${API_BASE_URL}/canchas`)
                ]);

                console.log('üìä Respuestas de API:', {
                    reservas: reservasRes.status,
                    usuarios: usuariosRes.status,
                    canchas: canchasRes.status
                });

                const reservas = await reservasRes.json();
                const usuarios = await usuariosRes.json();
                const canchas = await canchasRes.json();

                console.log('üìà Datos obtenidos:', {
                    reservas: reservas.length,
                    usuarios: usuarios.length,
                    canchas: canchas.length
                });

                // Filtrar reservas para el a√±o actual (ingresos totales del a√±o)
                const currentYear = new Date().getFullYear();
                const yearlyReservas = reservas.filter(reserva => {
                    const reservaDate = new Date(reserva.fecha || reserva.fecha_reserva);
                    return reservaDate.getFullYear() === currentYear;
                });
                console.log('üìä Reservas del a√±o actual:', yearlyReservas.length);

                // Calcular estad√≠sticas con datos del a√±o actual
                const totalReservations = yearlyReservas.length;
                const totalRevenue = yearlyReservas.reduce((sum, r) => sum + (parseFloat(r.totalPrice) || 0), 0);
                const activeFields = canchas.filter(c => c.estado === 'disponible' || c.estado === 'activa').length;
                const activeUsers = usuarios.filter(u => u.estado === 'activo' || !u.estado).length;

                console.log('üìä Estad√≠sticas calculadas:', {
                    totalReservations,
                    totalRevenue,
                    activeFields,
                    activeUsers
                });

                // Calcular cambios porcentuales (comparar con a√±o anterior)
                const previousYear = currentYear - 1;
                const previousYearReservas = reservas.filter(reserva => {
                    const reservaDate = new Date(reserva.fecha || reserva.fecha_reserva);
                    return reservaDate.getFullYear() === previousYear;
                });
                
                const previousTotal = previousYearReservas.length;
                const previousRevenue = previousYearReservas.reduce((sum, r) => sum + (parseFloat(r.totalPrice) || 0), 0);

                // Calcular porcentajes de cambio
                const reservationsChange = previousTotal > 0 ? ((totalReservations - previousTotal) / previousTotal * 100) : 0;
                const revenueChange = previousRevenue > 0 ? ((totalRevenue - previousRevenue) / previousRevenue * 100) : 0;

                // Actualizar UI
                document.getElementById('totalReservations').textContent = totalReservations;
                document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
                document.getElementById('activeFields').textContent = activeFields;
                document.getElementById('activeUsers').textContent = activeUsers;

                // Actualizar indicadores de cambio
                document.getElementById('reservationsChange').textContent = `${reservationsChange >= 0 ? '+' : ''}${reservationsChange.toFixed(1)}%`;
                document.getElementById('revenueChange').textContent = `${revenueChange >= 0 ? '+' : ''}${revenueChange.toFixed(1)}%`;
                
                // Colores para los cambios
                document.getElementById('reservationsChange').style.color = reservationsChange >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('revenueChange').style.color = revenueChange >= 0 ? '#10b981' : '#ef4444';

                // Mantener valores fijos para campos y usuarios (no dependen del per√≠odo)
                document.getElementById('fieldsChange').textContent = '0%';
                document.getElementById('usersChange').textContent = '+15%';

                console.log('üìä Estad√≠sticas actualizadas con filtros:', { 
                    totalReservations, 
                    totalRevenue, 
                    reservationsChange: reservationsChange.toFixed(1) + '%',
                    revenueChange: revenueChange.toFixed(1) + '%'
                });

            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas:', error);
                // Mostrar valores por defecto en caso de error
                document.getElementById('totalReservations').textContent = '0';
                document.getElementById('totalRevenue').textContent = '$0';
                document.getElementById('activeFields').textContent = '0';
                document.getElementById('activeUsers').textContent = '0';
            }
        }

        // Cargar gr√°ficos
        async function loadCharts() {
            try {
                console.log('üìä Cargando gr√°ficos...');
                const reservasRes = await fetch(`${API_BASE_URL}/reservas`);
                const reservas = await reservasRes.json();

                console.log('üìà Datos de reservas para gr√°ficos:', reservas.length);

                // Filtrar reservas para el a√±o actual (para gr√°ficos)
                const currentYear = new Date().getFullYear();
                const yearlyReservas = reservas.filter(reserva => {
                    const reservaDate = new Date(reserva.fecha || reserva.fecha_reserva);
                    return reservaDate.getFullYear() === currentYear;
                });
                console.log('üìä Reservas del a√±o actual para gr√°ficos:', yearlyReservas.length);

                // Gr√°fico de reservas por d√≠a
                createReservationsChart(yearlyReservas);
                
                // Gr√°fico de ingresos por mes
                createRevenueChart(yearlyReservas);
                
                // Gr√°fico de canchas m√°s populares
                createFieldsChart(yearlyReservas);
                
                // Gr√°fico de horarios de mayor demanda
                createHoursChart(yearlyReservas);

            } catch (error) {
                console.error('‚ùå Error cargando gr√°ficos:', error);
                // Crear gr√°ficos vac√≠os en caso de error
                createEmptyCharts();
            }
        }

        // Crear gr√°ficos vac√≠os en caso de error
        function createEmptyCharts() {
            const chartIds = ['reservationsChart', 'revenueChart', 'fieldsChart', 'hoursChart'];
            chartIds.forEach(id => {
                const ctx = document.getElementById(id);
                if (ctx) {
                    const chart = new Chart(ctx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Sin datos'],
                            datasets: [{
                                label: 'Sin datos disponibles',
                                data: [0],
                                backgroundColor: '#e2e8f0'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }
            });
        }

        // Crear gr√°fico de reservas por d√≠a/mes seg√∫n el per√≠odo
        function createReservationsChart(reservas) {
            const ctx = document.getElementById('reservationsChart').getContext('2d');
            
            console.log('üìÖ Creando gr√°fico de reservas...');
            
            // Obtener el rango de fechas del filtro
            const { startDate, endDate } = getDateRange();
            const periodDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            let labels = [];
            let reservationCounts = [];
            let chartTitle = 'Reservas';
            
            if (periodDays <= 7) {
                // Semana: mostrar por d√≠as de la semana
                const daysOfWeek = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
                labels = daysOfWeek;
                reservationCounts = new Array(7).fill(0);
                chartTitle = 'Reservas por D√≠a de la Semana';
                
                reservas.forEach(r => {
                    const fechaReserva = r.fecha || r.fecha_reserva;
                    if (fechaReserva) {
                        const date = new Date(fechaReserva);
                        const dayOfWeek = date.getDay(); // 0 = Domingo, 1 = Lunes, etc.
                        const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Ajustar para que Lunes = 0
                        reservationCounts[adjustedDay]++;
                    }
                });
                
            } else if (periodDays <= 180) {
                // 6 meses: mostrar por mes
                const months = [];
                const monthCounts = {};
                chartTitle = 'Reservas por Mes (√öltimos 6 Meses)';
                
                // Generar √∫ltimos 6 meses
                for (let i = 5; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const monthKey = date.toISOString().slice(0, 7); // YYYY-MM
                    const monthLabel = date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
                    months.push(monthLabel);
                    monthCounts[monthKey] = 0;
                }
                
                // Contar reservas por mes
                reservas.forEach(r => {
                    const fechaReserva = r.fecha || r.fecha_reserva;
                    if (fechaReserva) {
                        const monthKey = fechaReserva.slice(0, 7);
                        if (monthCounts.hasOwnProperty(monthKey)) {
                            monthCounts[monthKey]++;
                        }
                    }
                });
                
                labels = months;
                reservationCounts = Object.values(monthCounts);
                
            } else {
                // A√±o completo: mostrar por mes del a√±o
                const monthsOfYear = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                labels = monthsOfYear;
                reservationCounts = new Array(12).fill(0);
                chartTitle = 'Reservas por Mes del A√±o';
                
                reservas.forEach(r => {
                    const fechaReserva = r.fecha || r.fecha_reserva;
                    if (fechaReserva) {
                        const date = new Date(fechaReserva);
                        const month = date.getMonth(); // 0 = Enero, 11 = Diciembre
                        reservationCounts[month]++;
                    }
                });
            }

            console.log('üìÖ Datos del gr√°fico:', { chartTitle, labels, reservationCounts, periodDays });

            if (charts.reservations) {
                charts.reservations.destroy();
            }

            charts.reservations = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartTitle,
                        data: reservationCounts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: chartTitle,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Crear gr√°fico de ingresos por mes
        // Crear gr√°fico de ingresos por d√≠a/mes seg√∫n el per√≠odo
        function createRevenueChart(reservas) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            console.log('üí∞ Creando gr√°fico de ingresos...');
            console.log('üí∞ Datos de reservas recibidos:', reservas);
            console.log('üí∞ Estructura de primera reserva:', reservas[0]);
            
            // Obtener el rango de fechas del filtro
            const { startDate, endDate } = getDateRange();
            const periodDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            let labels = [];
            let revenues = [];
            let chartTitle = 'Ingresos';
            
            if (periodDays <= 7) {
                // Semana: mostrar por d√≠as de la semana
                const daysOfWeek = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
                labels = daysOfWeek;
                revenues = new Array(7).fill(0);
                chartTitle = 'Ingresos por D√≠a de la Semana';
                
                reservas.forEach(r => {
                    const fechaReserva = r.fecha || r.fecha_reserva;
                    const precio = parseFloat(r.totalPrice) || 0;
                    console.log('üí∞ Procesando reserva:', { fechaReserva, precio, totalPrice: r.totalPrice, reserva: r });
                    
                    if (fechaReserva && precio > 0) {
                        const date = new Date(fechaReserva);
                        const dayOfWeek = date.getDay(); // 0 = Domingo, 1 = Lunes, etc.
                        const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Ajustar para que Lunes = 0
                        revenues[adjustedDay] += precio;
                        console.log('üí∞ Sumando al d√≠a', adjustedDay, ':', precio);
                    }
                });
                
            } else if (periodDays <= 180) {
                // 6 meses: mostrar por mes
                const months = [];
                const monthRevenues = {};
                chartTitle = 'Ingresos por Mes (√öltimos 6 Meses)';
                
                // Generar √∫ltimos 6 meses
                for (let i = 5; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const monthKey = date.toISOString().slice(0, 7); // YYYY-MM
                    const monthLabel = date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
                    months.push(monthLabel);
                    monthRevenues[monthKey] = 0;
                }
                
                // Sumar ingresos por mes
                reservas.forEach(r => {
                    const fechaReserva = r.fecha || r.fecha_reserva;
                    const precio = parseFloat(r.totalPrice) || 0;
                    
                    if (fechaReserva && precio > 0) {
                        const monthKey = fechaReserva.slice(0, 7);
                        if (monthRevenues.hasOwnProperty(monthKey)) {
                            monthRevenues[monthKey] += precio;
                            console.log('üí∞ Sumando al mes', monthKey, ':', precio);
                        }
                    }
                });
                
                labels = months;
                revenues = Object.values(monthRevenues);
                
            } else {
                // A√±o completo: mostrar por mes del a√±o
                const monthsOfYear = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                labels = monthsOfYear;
                revenues = new Array(12).fill(0);
                chartTitle = 'Ingresos por Mes del A√±o';
                
                reservas.forEach(r => {
                    const fechaReserva = r.fecha || r.fecha_reserva;
                    const precio = parseFloat(r.totalPrice) || 0;
                    
                    if (fechaReserva && precio > 0) {
                        const date = new Date(fechaReserva);
                        const month = date.getMonth(); // 0 = Enero, 11 = Diciembre
                        revenues[month] += precio;
                        console.log('üí∞ Sumando al mes', month, ':', precio);
                    }
                });
            }

            console.log('üí∞ Datos del gr√°fico de ingresos:', { chartTitle, labels, revenues, periodDays });

            if (charts.revenue) {
                charts.revenue.destroy();
            }

            charts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ingresos',
                        data: revenues,
                        backgroundColor: 'rgba(66, 153, 225, 0.8)',
                        borderColor: '#4299e1',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Crear gr√°fico de canchas m√°s populares
        async function createFieldsChart(reservas) {
            const ctx = document.getElementById('fieldsChart').getContext('2d');
            
            try {
                console.log('üèüÔ∏è Cargando datos de canchas...');
                const canchasRes = await fetch(`${API_BASE_URL}/canchas`);
                const canchas = await canchasRes.json();
                
                console.log('üèüÔ∏è Canchas obtenidas:', canchas.length);
                console.log('üìä Reservas para an√°lisis:', reservas.length);
                
                // Contar reservas por cancha
                const canchaStats = canchas.map(cancha => {
                    const count = reservas.filter(r => r.id_cancha === cancha.id).length;
                    return { nombre: cancha.nombre_cancha || `Cancha ${cancha.id}`, count };
                }).sort((a, b) => b.count - a.count).slice(0, 5);

                console.log('üìà Estad√≠sticas de canchas:', canchaStats);

                if (charts.fields) {
                    charts.fields.destroy();
                }

                // Si no hay datos, mostrar gr√°fico vac√≠o
                if (canchaStats.every(c => c.count === 0)) {
                    charts.fields = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Sin reservas'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#e2e8f0']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                } else {
                    charts.fields = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: canchaStats.map(c => c.nombre),
                            datasets: [{
                                data: canchaStats.map(c => c.count),
                                backgroundColor: [
                                    '#667eea',
                                    '#764ba2',
                                    '#4299e1',
                                    '#f093fb',
                                    '#f56565'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('‚ùå Error creando gr√°fico de canchas:', error);
                // Crear gr√°fico vac√≠o en caso de error
                charts.fields = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Error al cargar'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#f56565']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        }

        // Crear gr√°fico de horarios de mayor demanda
        function createHoursChart(reservas) {
            const ctx = document.getElementById('hoursChart').getContext('2d');
            
            console.log('‚è∞ Creando gr√°fico de horarios...');
            
            // Procesar datos por hora
            const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
            const hourCounts = new Array(24).fill(0);
            
            reservas.forEach(reserva => {
                // Intentar diferentes formatos de hora
                let horaInicio = reserva.horaInicio || reserva.hora_inicio || reserva.hora;
                if (horaInicio) {
                    const hour = parseInt(horaInicio.split(':')[0]);
                    if (hour >= 0 && hour < 24) {
                        hourCounts[hour]++;
                    }
                }
            });

            console.log('‚è∞ Conteo por horas:', hourCounts);

            if (charts.hours) {
                charts.hours.destroy();
            }

            charts.hours = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Reservas',
                        data: hourCounts,
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: '#764ba2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Cargar tablas
        async function loadTables() {
            try {
                await Promise.all([
                    loadTopUsers(),
                    loadRecentReservations()
                ]);
            } catch (error) {
                console.error('Error cargando tablas:', error);
            }
        }

        // Cargar top usuarios
        async function loadTopUsers() {
            try {
                const [usuariosRes, reservasRes, canchasRes, tarifasRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/usuarios`),
                    fetch(`${API_BASE_URL}/reservas`),
                    fetch(`${API_BASE_URL}/canchas`),
                    fetch(`${API_BASE_URL}/tarifas`)
                ]);

                const usuarios = await usuariosRes.json();
                const reservas = await reservasRes.json();
                const canchas = await canchasRes.json();
                const tarifas = await tarifasRes.json();

                console.log('üìä Datos para usuarios activos:', { usuarios: usuarios.length, reservas: reservas.length, canchas: canchas.length, tarifas: tarifas.length });

                // Calcular estad√≠sticas por usuario
                const userStats = usuarios.map(usuario => {
                    const userReservas = reservas.filter(r => r.id_usuario === usuario.id);
                    
                    // Calcular total gastado usando totalPrice de cada reserva
                    const totalGastado = userReservas.reduce((sum, r) => {
                        return sum + (parseFloat(r.totalPrice) || 0);
                    }, 0);
                    
                    // Obtener fecha de √∫ltima reserva
                    const ultimaReserva = userReservas.length > 0 
                        ? Math.max(...userReservas.map(r => new Date(r.fecha_reserva).getTime()))
                        : 0;

                    return {
                        ...usuario,
                        reservasCount: userReservas.length,
                        totalGastado,
                        ultimaReserva: ultimaReserva ? new Date(ultimaReserva) : null
                    };
                }).sort((a, b) => b.reservasCount - a.reservasCount).slice(0, 10);

                console.log('üìà Estad√≠sticas de usuarios:', userStats);

                const tbody = document.getElementById('topUsersBody');
                tbody.innerHTML = userStats.map(user => `
                    <tr>
                        <td>${user.nombre || 'Sin nombre'}</td>
                        <td>${user.correo || user.email || 'Sin email'}</td>
                        <td>${user.reservasCount}</td>
                        <td>$${user.totalGastado.toLocaleString()}</td>
                        <td>${user.ultimaReserva ? user.ultimaReserva.toLocaleDateString('es-ES') : 'Nunca'}</td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error cargando top usuarios:', error);
            }
        }

        // Cargar reservas recientes
        async function loadRecentReservations() {
            try {
                const [reservasRes, usuariosRes, canchasRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/reservas`),
                    fetch(`${API_BASE_URL}/usuarios`),
                    fetch(`${API_BASE_URL}/canchas`)
                ]);

                const reservas = await reservasRes.json();
                const usuarios = await usuariosRes.json();
                const canchas = await canchasRes.json();

                console.log('üîç DEBUG - Total reservas obtenidas:', reservas.length);
                console.log('üîç DEBUG - Todas las reservas:', reservas);
                
                // Buscar espec√≠ficamente reservas del 26/9/2025
                const reservas26Sept = reservas.filter(r => {
                    const fecha = r.fecha_reserva || r.fecha;
                    if (fecha) {
                        const fechaObj = new Date(fecha);
                        return fechaObj.getDate() === 26 && fechaObj.getMonth() === 8 && fechaObj.getFullYear() === 2025; // Mes 8 = Septiembre
                    }
                    return false;
                });
                console.log('üîç DEBUG - Reservas del 26/9/2025 encontradas:', reservas26Sept.length, reservas26Sept);

                // Mostrar informaci√≥n de ordenamiento
                console.log('üîç DEBUG - Informaci√≥n de IDs y fechas de creaci√≥n:');
                reservas.forEach((r, index) => {
                    if (index < 15) { // Solo mostrar las primeras 15 para no saturar
                        console.log(`ID: ${r.id}, createdAt: ${r.createdAt}, fecha_reserva: ${r.fecha_reserva}`);
                    }
                });

                // Ordenar por ID descendente para obtener las √∫ltimas reservas creadas
                const sortedReservas = reservas.sort((a, b) => {
                    // Si existe createdAt, usarlo; si no, usar ID
                    if (a.createdAt && b.createdAt) {
                        const dateA = new Date(a.createdAt);
                        const dateB = new Date(b.createdAt);
                        console.log(`üîç Comparando createdAt: ${a.id} (${a.createdAt}) vs ${b.id} (${b.createdAt})`);
                        return dateB - dateA;
                    }
                    // Ordenar por ID descendente (las m√°s recientes tienen ID m√°s alto)
                    console.log(`üîç Comparando IDs: ${a.id} vs ${b.id}`);
                    return (b.id || 0) - (a.id || 0);
                });

                console.log('üîç DEBUG - Primeras 10 reservas despu√©s del ordenamiento:');
                sortedReservas.slice(0, 10).forEach((r, index) => {
                    console.log(`${index + 1}. ID: ${r.id}, fecha_reserva: ${r.fecha_reserva}, createdAt: ${r.createdAt}`);
                });

                const recentReservations = sortedReservas
                    .slice(0, 10)
                    .map(reserva => {
                        const usuario = usuarios.find(u => u.id === reserva.id_usuario);
                        const cancha = canchas.find(c => c.id === reserva.id_cancha);
                        return { ...reserva, usuario, cancha };
                    });

                console.log('üîç DEBUG - Reservas recientes finales:', recentReservations);

                const tbody = document.getElementById('recentReservationsBody');
                tbody.innerHTML = recentReservations.map(reserva => `
                    <tr>
                        <td>${reserva.fecha_reserva ? new Date(reserva.fecha_reserva).toLocaleDateString('es-ES') : 'N/A'}</td>
                        <td>${reserva.usuario ? (reserva.usuario.nombre || 'Sin nombre') : 'N/A'}</td>
                        <td>${reserva.cancha ? (reserva.cancha.nombre_cancha || 'Sin nombre') : 'N/A'}</td>
                        <td>${reserva.hora_inicio || 'N/A'} - ${reserva.hora_fin || 'N/A'}</td>
                        <td><span class="user-status status-${reserva.estado || 'pendiente'}">${reserva.estado || 'Pendiente'}</span></td>
                        <td>$${(reserva.totalPrice || 0).toLocaleString()}</td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error cargando reservas recientes:', error);
            }
        }

        // Exportar a CSV
        function exportToCSV(tableType) {
            let data = [];
            let filename = '';

            if (tableType === 'topUsers') {
                const table = document.getElementById('topUsersTable');
                filename = 'top_usuarios.csv';
                data = tableToArray(table);
            } else if (tableType === 'recentReservations') {
                const table = document.getElementById('recentReservationsTable');
                filename = 'reservas_recientes.csv';
                data = tableToArray(table);
            }

            downloadCSV(data, filename);
        }

        // Convertir tabla a array
        function tableToArray(table) {
            const data = [];
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('th, td');
                cells.forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                data.push(rowData);
            });
            
            return data;
        }

        // Descargar CSV
        function downloadCSV(data, filename) {
            const csv = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Event listeners para filtros
        document.getElementById('periodFilter').addEventListener('change', function() {
            console.log('üîÑ Filtro de per√≠odo cambiado:', this.value);
            // Limpiar fechas personalizadas cuando se selecciona un per√≠odo predefinido
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            loadReports();
        });

        document.getElementById('dateFrom').addEventListener('change', function() {
            console.log('üîÑ Fecha desde cambiada:', this.value);
            loadReports();
        });

        document.getElementById('dateTo').addEventListener('change', function() {
            console.log('üîÑ Fecha hasta cambiada:', this.value);
            loadReports();
        });

        // Inicializar fechas
        function initializeDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                initializeDates();
                loadReports();
            }
        });
    </script>
</body>
</html>
